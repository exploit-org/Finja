package org.exploit.finja.core.key;

import lombok.AllArgsConstructor;
import org.exploit.crypto.key.ECPublicKey;
import org.exploit.crypto.key.ed25519.Ed25519PublicKey;
import org.exploit.ed25519.Ed25519PointOps;
import org.exploit.tkeeper.sdk.TKeeperClient;
import org.exploit.tkeeper.sdk.model.SessionType;
import org.exploit.tkeeper.sdk.model.Sign;
import org.exploit.tss.signature.SchnorrSignature;
import org.exploit.tss.signature.Signature;

import java.util.Arrays;
import java.util.Base64;
import java.util.Map;
import java.util.UUID;

@AllArgsConstructor
public class ThresholdEd25519KeyManager implements ECKeyManager<Ed25519PointOps> {
    private final String keyId;
    private final TKeeperClient client;

    @Override
    public Signature sign(byte[] data, int flags) {
        var opId = UUID.randomUUID().toString();
        var ops = Map.of(opId, Base64.getEncoder().encodeToString(data));
        var request = new Sign(keyId, SessionType.FROST, ops);

        var response = client.signature().sign(request);
        var decodedSignature = Base64.getDecoder().decode(response.signature().get(opId));
        var r = Arrays.copyOfRange(decodedSignature, 0, 32);
        var s = Arrays.copyOfRange(decodedSignature, 32, 64);

        return new SchnorrSignature(r, s);
    }

    @Override
    public ECPublicKey<Ed25519PointOps> getPublicKey() {
        var dto = client.central().getPublicKey(keyId);
        var decoded = Base64.getDecoder().decode(dto.data64());

        return new Ed25519PublicKey(decoded);
    }

    @Override
    public void erase() {}
}
