package org.exploit.finja.core.key;

import lombok.AllArgsConstructor;
import org.exploit.crypto.key.ECPublicKey;
import org.exploit.crypto.key.ed25519.Ed25519PublicKey;
import org.exploit.ed25519.Ed25519PointOps;
import org.exploit.tsec.TSecurityClient;
import org.exploit.tsec.constant.CurveName;
import org.exploit.tsec.constant.SessionType;
import org.exploit.tsec.constant.SigType;
import org.exploit.tsec.exception.KeeperException;
import org.exploit.tsec.model.OperationsDto;
import org.exploit.tsec.model.Sign;
import org.exploit.tsec.signature.DecodedSchnorrSignature;
import org.exploit.tss.signature.SchnorrSignature;
import org.exploit.tss.signature.Signature;

import java.util.Base64;
import java.util.Map;
import java.util.UUID;

@AllArgsConstructor
public class ThresholdEd25519KeyManager implements ECKeyManager<Ed25519PointOps> {
    private final String keyId;
    private final TSecurityClient client;

    @Override
    public Signature sign(byte[] data, int flags) {
        var opId = UUID.randomUUID().toString();
        var ops = new OperationsDto(Map.of(opId, Base64.getEncoder().encodeToString(data)));

        var request = Sign.newBuilder()
                .operations(ops)
                .keyId(keyId)
                .type(SessionType.FROST)
                .sigType(SigType.SCHNORR)
                .curve(CurveName.ED25519)
                .build();

        var response = client.sign(request);
        var decodedSignature = response.getSignature()
                .getSignatures()
                .get(opId);

        if (!(decodedSignature instanceof DecodedSchnorrSignature schnorr)) {
            throw new KeeperException("No signature found for operation ID: " + opId);
        }

        return new SchnorrSignature(schnorr.r(), schnorr.s());
    }

    @Override
    public ECPublicKey<Ed25519PointOps> getPublicKey() {
        var dto = client.publicKey(keyId);
        var decoded = Base64.getDecoder().decode(dto.getData64());

        return new Ed25519PublicKey(decoded);
    }

    @Override
    public void erase() {}
}
