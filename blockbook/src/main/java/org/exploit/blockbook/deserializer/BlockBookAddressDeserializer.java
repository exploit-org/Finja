package org.exploit.blockbook.deserializer;

import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.databind.*;
import org.exploit.blockbook.model.address.BitcoinTypeAddress;
import org.exploit.blockbook.model.address.BlockBookAddress;
import org.exploit.blockbook.model.address.EvmTypeAddress;
import org.exploit.blockbook.model.address.XPubAddress;

import java.io.IOException;

public class BlockBookAddressDeserializer extends JsonDeserializer<BlockBookAddress> {
    private static final ObjectMapper CLEAN_MAPPER = new ObjectMapper();

    @Override
    public BlockBookAddress deserialize(JsonParser jp, DeserializationContext ctx) throws IOException {
        var mapper = jp.getCodec();
        JsonNode node = mapper.readTree(jp);

        if (!node.has("address"))
            throw new JsonMappingException(jp, "Invalid address object: missing 'address' field");

        var address = node.get("address").asText();

        if (address.startsWith("0x"))
            return CLEAN_MAPPER.treeToValue(node, EvmTypeAddress.class);

        return CLEAN_MAPPER.treeToValue(node, BitcoinTypeAddress.class);
    }
}