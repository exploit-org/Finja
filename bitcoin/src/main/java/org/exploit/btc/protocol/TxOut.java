package org.exploit.btc.protocol;

import lombok.Setter;
import org.exploit.btc.stereotype.BtcSerializable;

import java.math.BigInteger;
import java.nio.ByteBuffer;
import java.nio.ByteOrder;

public final class TxOut implements BtcSerializable {
    @Setter
    private boolean isChange;
    @Setter
    private BigInteger amount;

    private final Script pubKeyScript;

    public TxOut(boolean isChange, BigInteger amount, Script pubKeyScript) {
        this.isChange = isChange;
        this.amount = amount;
        this.pubKeyScript = pubKeyScript;
    }

    public TxOut(BigInteger amount, Script pubKeyScript) {
        this(false, amount, pubKeyScript);
    }

    @Override
    public byte[] serialize(int flags) {
        var valueBytes = ByteBuffer.allocate(Long.BYTES).order(ByteOrder.LITTLE_ENDIAN)
                .putLong(amount.longValue())
                .array();

        var scriptBytes = pubKeyScript.serialize(flags);

        var buffer = ByteBuffer.allocate(valueBytes.length + scriptBytes.length);

        return buffer.order(ByteOrder.LITTLE_ENDIAN)
                .put(valueBytes)
                .put(scriptBytes)
                .array();
    }

    public boolean isChange() {
        return isChange;
    }

    public BigInteger amount() {
        return amount;
    }

    public Script pubKeyScript() {
        return pubKeyScript;
    }
}