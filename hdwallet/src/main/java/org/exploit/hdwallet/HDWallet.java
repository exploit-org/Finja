package org.exploit.hdwallet;

import org.exploit.crypto.constant.SupportedCurve;
import org.exploit.finja.stereotype.Sensitive;
import org.exploit.hdwallet.key.XKeyPair;
import org.exploit.hdwallet.model.Seed;
import org.exploit.hdwallet.utils.LRUCache;
import org.exploit.hdwallet.utils.MasterKeys;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

public class HDWallet implements Sensitive {
    private final Seed seed;

    private final HDKeyService keyService;

    public HDWallet(Seed seed, int maxDerivations) {
        this.seed = seed;
        this.keyService = new HDKeyService(maxDerivations);
    }

    public HDWallet(Seed seed) {
        this(seed, 100);
    }

    public XKeyPair<?> derive(SupportedCurve curve, String path, byte[] chainCode) {
        var masterKey = MasterKeys.create(seed, curve);

        try {
            var parts = path.split("/");
            var currentKey = masterKey;

            for (var part : parts) {
                if (!part.equals("m")) {
                    var index = getIndexFromPathPart(curve, part);
                    currentKey = keyService.deriveChildKey(currentKey, index, chainCode);
                }
            }

            return currentKey;
        } finally {
            masterKey.erase();;
        }
    }

    public XKeyPair<?> derive(SupportedCurve curve, String path) {
        return derive(curve, path, new byte[0]);
    }

    private int getIndexFromPathPart(SupportedCurve curve, String part) {
        var isHardened = part.endsWith("'") || curve == SupportedCurve.ED25519;
        var index = Integer.parseInt(part.replace("'", ""));

        if (isHardened)
            index |= 0x80000000;

        return index;
    }

    @Override
    public void erase() {
        seed.erase();
    }
}